
// ============================================
// iCalendar/iCloud Integration Schema Additions
// ============================================
// These models are ADDITIVE and do not modify existing functionality
// Add these to the main schema.prisma file

// Enum for calendar sync providers
enum CalendarProvider {
  ICLOUD_CALDAV
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
}

// Enum for sync status
enum SyncStatus {
  ACTIVE
  PAUSED
  ERROR
  DISCONNECTED
}

// External Calendar Connection
// Stores user's connection to external calendar services
model ExternalCalendarConnection {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider          CalendarProvider
  calendarUrl       String            // CalDAV calendar URL
  calendarName      String?           // Display name of the calendar
  
  // Encrypted credentials (using node-forge AES-256)
  encryptedUsername String            @db.Text // Apple ID for iCloud
  encryptedPassword String            @db.Text // App-specific password
  
  // Sync state management
  syncStatus        SyncStatus        @default(ACTIVE)
  syncToken         String?           @db.Text // WebDAV-Sync token (RFC 6578)
  ctag              String?           // CTag for fallback polling
  lastSyncAt        DateTime?
  lastSyncError     String?           @db.Text
  
  // Configuration
  syncInterval      Int               @default(300) // Seconds between syncs (default 5 min)
  bidirectionalSync Boolean           @default(true) // Enable two-way sync
  autoExport        Boolean           @default(true) // Auto-export new appointments
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  syncLogs          CalendarSyncLog[]
  
  @@unique([userId, provider, calendarUrl])
  @@map("external_calendar_connections")
}

// Calendar Sync Log
// Tracks all sync operations for debugging and audit
model CalendarSyncLog {
  id                String                      @id @default(cuid())
  connectionId      String
  connection        ExternalCalendarConnection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  syncType          String                      // "INITIAL", "POLL", "MANUAL", "PUSH"
  direction         String                      // "IMPORT", "EXPORT", "BIDIRECTIONAL"
  status            String                      // "SUCCESS", "PARTIAL", "FAILED"
  
  eventsImported    Int                         @default(0)
  eventsExported    Int                         @default(0)
  eventsUpdated     Int                         @default(0)
  eventsDeleted     Int                         @default(0)
  conflictsResolved Int                         @default(0)
  
  errorMessage      String?                     @db.Text
  errorDetails      String?                     @db.Text // JSON with detailed error info
  
  duration          Int?                        // Sync duration in milliseconds
  
  createdAt         DateTime                    @default(now())
  
  @@index([connectionId, createdAt])
  @@map("calendar_sync_logs")
}

// Add optional fields to existing Appointment model
// These fields link appointments to external calendar events
// IMPORTANT: Add these fields to the existing Appointment model, don't create a new one

// Add to Appointment model:
// externalConnectionId  String?
// externalConnection    ExternalCalendarConnection? @relation(fields: [externalConnectionId], references: [id], onDelete: SetNull)
// externalEventUrl      String?                     // Unique URL of the event on CalDAV server
// externalEventUid      String?                     // iCalendar UID
// externalEtag          String?                     // ETag for version tracking
// lastModifiedSource    String?                     // "CITAPLANNER" or "EXTERNAL"
// icloudSyncEnabled     Boolean                     @default(false) // Per-appointment sync toggle
