
{
  "version": "1.0",
  "project": {
    "name": "CitaPlanner",
    "description": "Sistema de gestión de citas para múltiples negocios"
  },
  "services": {
    "app": {
      "name": "citaplanner-app",
      "type": "app",
      "source": {
        "type": "github",
        "repo": "qhosting/citaplanner",
        "branch": "main",
        "autoDeploy": true
      },
      "build": {
        "type": "nixpacks",
        "buildCommand": "npm run build",
        "startCommand": "npm start"
      },
      "resources": {
        "cpuLimit": 1,
        "cpuReservation": 0.5,
        "memoryLimit": 2048,
        "memoryReservation": 512
      },
      "deploy": {
        "replicas": 1,
        "zeroDowntime": true
      },
      "domains": [
        {
          "host": "citaplanner.com",
          "https": true,
          "port": 3000,
          "path": "/"
        }
      ],
      "env": {
        "required": [
          "DATABASE_URL",
          "NEXTAUTH_URL",
          "NEXTAUTH_SECRET",
          "MASTER_PASSWORD_HASH",
          "NODE_ENV",
          "PORT"
        ],
        "optional": [
          "EMAIL_SERVER_HOST",
          "EMAIL_SERVER_PORT",
          "EMAIL_SERVER_USER",
          "EMAIL_SERVER_PASSWORD",
          "EMAIL_FROM",
          "TWILIO_ACCOUNT_SID",
          "TWILIO_AUTH_TOKEN",
          "TWILIO_PHONE_NUMBER"
        ],
        "notes": {
          "DATABASE_URL": "CRITICAL: Use the exact PostgreSQL service name from Easypanel. Format: postgresql://postgres:PASSWORD@SERVICE_NAME:5432/DATABASE_NAME. Common service names: citaplanner-db, citaplanner-postgres, postgres. Example: postgresql://postgres:674a351a07db86883d92@citaplanner-db:5432/citaplanner-db"
        }
      },
      "mounts": [
        {
          "type": "volume",
          "name": "citaplanner-uploads",
          "mountPath": "/app/public/uploads"
        }
      ],
      "healthCheck": {
        "path": "/api/health",
        "interval": 30,
        "timeout": 10,
        "retries": 3
      }
    },
    "database": {
      "name": "citaplanner-db",
      "type": "postgres",
      "image": "postgres:16-alpine",
      "resources": {
        "cpuLimit": 0.5,
        "cpuReservation": 0.25,
        "memoryLimit": 1024,
        "memoryReservation": 256
      },
      "env": {
        "required": [
          "POSTGRES_USER",
          "POSTGRES_PASSWORD",
          "POSTGRES_DB"
        ],
        "defaults": {
          "POSTGRES_USER": "postgres",
          "POSTGRES_DB": "citaplanner-db"
        }
      },
      "mounts": [
        {
          "type": "volume",
          "name": "citaplanner-postgres-data",
          "mountPath": "/var/lib/postgresql/data"
        }
      ],
      "backup": {
        "enabled": true,
        "schedule": "0 2 * * *",
        "retention": 7
      }
    }
  },
  "network": {
    "internal": true,
    "links": [
      {
        "from": "citaplanner-app",
        "to": "citaplanner-db",
        "alias": "database"
      }
    ],
    "notes": {
      "connectivity": "The app service connects to the database using the service name 'citaplanner-db'. Both services must be on the same internal network. The DATABASE_URL must use the exact service name configured in Easypanel."
    }
  },
  "deployment": {
    "strategy": "rolling",
    "maxSurge": 1,
    "maxUnavailable": 0
  },
  "monitoring": {
    "enabled": true,
    "metrics": [
      "cpu",
      "memory",
      "network",
      "disk"
    ]
  },
  "security": {
    "ssl": {
      "enabled": true,
      "provider": "letsencrypt",
      "email": "admin@citaplanner.com"
    },
    "firewall": {
      "enabled": true,
      "allowedPorts": [80, 443]
    }
  },
  "troubleshooting": {
    "database_connectivity": {
      "issue": "Cannot connect to PostgreSQL",
      "common_causes": [
        "Incorrect service name in DATABASE_URL",
        "Services not on the same network",
        "PostgreSQL service not running",
        "Incorrect credentials"
      ],
      "solution": "Verify the PostgreSQL service name in Easypanel matches the host in DATABASE_URL. See EASYPANEL_DATABASE_CONNECTIVITY_FIX.md for detailed instructions."
    }
  }
}
