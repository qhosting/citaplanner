
# üìä Fase 3: Sistema de Reportes por Profesional y Sucursal

## üìã Resumen

Sistema completo de reportes y an√°lisis de datos que permite visualizar m√©tricas clave, tendencias y estad√≠sticas detalladas por profesional, sucursal y a nivel general. Incluye dashboards interactivos con gr√°ficos, filtros de fecha y exportaci√≥n de datos.

## üéØ Caracter√≠sticas Implementadas

### ‚úÖ Backend - Servicio de Reportes

#### ReportManager Service
Servicio centralizado para generaci√≥n de reportes con las siguientes capacidades:

**M√©todos Principales:**
- `calculateDateRange()` - Calcula rangos de fechas seg√∫n per√≠odo
- `calculateAppointmentMetrics()` - M√©tricas de citas (total, completadas, canceladas, etc.)
- `calculateRevenueMetrics()` - M√©tricas de ingresos (total, promedio, proyectado)
- `calculateTimeMetrics()` - M√©tricas de tiempo (horas trabajadas, utilizaci√≥n, horas pico)
- `calculateClientMetrics()` - M√©tricas de clientes (total, nuevos, retenci√≥n)
- `calculateAppointmentTrend()` - Tendencias de citas en el tiempo
- `calculateRevenueTrend()` - Tendencias de ingresos en el tiempo
- `generateProfessionalReport()` - Reporte completo de profesional
- `generateBranchReport()` - Reporte completo de sucursal
- `generateOverviewReport()` - Reporte general del negocio
- `generateComparisonReport()` - Reporte comparativo entre profesionales o sucursales

**Per√≠odos Soportados:**
- D√≠a (hoy)
- Semana (√∫ltimos 7 d√≠as)
- Mes (√∫ltimos 30 d√≠as)
- A√±o (√∫ltimos 365 d√≠as)
- Personalizado (rango de fechas custom)

### ‚úÖ API Endpoints

#### 1. GET `/api/reports/professional/[id]`
Genera reporte detallado de un profesional espec√≠fico.

**Query Parameters:**
- `period` - Per√≠odo del reporte (day, week, month, year, custom)
- `startDate` - Fecha inicio (para per√≠odo custom)
- `endDate` - Fecha fin (para per√≠odo custom)

**Response:**
```typescript
{
  success: true,
  data: {
    professionalId: string,
    professionalName: string,
    period: ReportPeriod,
    dateRange: { startDate: Date, endDate: Date },
    appointments: AppointmentMetrics,
    revenue: RevenueMetrics,
    time: TimeMetrics,
    clients: ClientMetrics,
    branches: Array<BranchPerformance>,
    services: Array<ServicePerformance>,
    trends: {
      appointmentTrend: Array<TrendPoint>,
      revenueTrend: Array<TrendPoint>
    }
  },
  generatedAt: Date,
  filters: ReportFilters
}
```

#### 2. GET `/api/reports/branch/[id]`
Genera reporte detallado de una sucursal espec√≠fica.

**Query Parameters:**
- `period` - Per√≠odo del reporte
- `startDate` - Fecha inicio (opcional)
- `endDate` - Fecha fin (opcional)

**Response:**
```typescript
{
  success: true,
  data: {
    branchId: string,
    branchName: string,
    period: ReportPeriod,
    dateRange: { startDate: Date, endDate: Date },
    appointments: AppointmentMetrics,
    revenue: RevenueMetrics,
    time: TimeMetrics,
    clients: ClientMetrics,
    professionals: Array<ProfessionalPerformance>,
    services: Array<ServicePerformance>,
    trends: {
      appointmentTrend: Array<TrendPoint>,
      revenueTrend: Array<TrendPoint>
    }
  },
  generatedAt: Date,
  filters: ReportFilters
}
```

#### 3. GET `/api/reports/overview`
Genera reporte general del negocio.

**Query Parameters:**
- `period` - Per√≠odo del reporte
- `startDate` - Fecha inicio (opcional)
- `endDate` - Fecha fin (opcional)

**Response:**
```typescript
{
  success: true,
  data: {
    tenantId: string,
    period: ReportPeriod,
    dateRange: { startDate: Date, endDate: Date },
    appointments: AppointmentMetrics,
    revenue: RevenueMetrics,
    time: TimeMetrics,
    clients: ClientMetrics,
    topProfessionals: Array<TopPerformer>,
    topBranches: Array<TopPerformer>,
    topServices: Array<TopService>,
    trends: {
      appointmentTrend: Array<TrendPoint>,
      revenueTrend: Array<TrendPoint>
    }
  },
  generatedAt: Date,
  filters: ReportFilters
}
```

#### 4. GET `/api/reports/comparison`
Genera reporte comparativo entre m√∫ltiples profesionales o sucursales.

**Query Parameters:**
- `type` - Tipo de comparaci√≥n (professional | branch)
- `ids` - IDs separados por coma (ej: "id1,id2,id3")
- `period` - Per√≠odo del reporte
- `startDate` - Fecha inicio (opcional)
- `endDate` - Fecha fin (opcional)

**Response:**
```typescript
{
  success: true,
  data: {
    period: ReportPeriod,
    dateRange: { startDate: Date, endDate: Date },
    type: 'professional' | 'branch',
    items: Array<{
      id: string,
      name: string,
      appointments: AppointmentMetrics,
      revenue: RevenueMetrics,
      clients: ClientMetrics
    }>
  },
  generatedAt: Date,
  filters: ReportFilters
}
```

### ‚úÖ Frontend - Componentes UI

#### 1. ReportDashboard
Dashboard general con vista de todas las m√©tricas del negocio.

**Caracter√≠sticas:**
- Selector de per√≠odo (d√≠a, semana, mes, a√±o, personalizado)
- Selector de rango de fechas personalizado
- Tarjetas de m√©tricas clave (citas, ingresos, clientes, horas)
- Gr√°ficos de tendencias (l√≠neas)
- Top 10 profesionales (gr√°fico de barras)
- Top 10 sucursales (gr√°fico de barras)
- Top 10 servicios (lista con m√©tricas)
- Actualizaci√≥n en tiempo real

#### 2. ProfessionalReportView
Vista detallada de reporte de profesional individual.

**Caracter√≠sticas:**
- Selector de per√≠odo
- M√©tricas principales en tarjetas
- Gr√°fico de pastel (estado de citas)
- Gr√°fico de barras (horas pico)
- Gr√°ficos de tendencias (citas e ingresos)
- Lista de sucursales con desempe√±o
- Gr√°fico de servicios m√°s realizados
- Informaci√≥n de clientes y retenci√≥n

#### 3. BranchReportView
Vista detallada de reporte de sucursal individual.

**Caracter√≠sticas:**
- Selector de per√≠odo
- M√©tricas principales en tarjetas
- Gr√°fico de pastel (estado de citas)
- Gr√°fico de barras (horas pico)
- Gr√°ficos de tendencias (citas e ingresos)
- Lista de profesionales con desempe√±o
- Gr√°fico de servicios m√°s solicitados
- Tasa de utilizaci√≥n de la sucursal

### ‚úÖ P√°ginas del Dashboard

#### 1. `/dashboard/reports`
P√°gina principal de reportes con dashboard general.

**Funcionalidades:**
- Vista general del negocio
- Filtros de per√≠odo
- M√©tricas consolidadas
- Gr√°ficos interactivos
- Top performers

#### 2. `/dashboard/reports/professional/[id]`
P√°gina de reporte individual de profesional.

**Funcionalidades:**
- M√©tricas espec√≠ficas del profesional
- Desempe√±o por sucursal
- Servicios m√°s realizados
- Tendencias personales
- Informaci√≥n de clientes

#### 3. `/dashboard/reports/branch/[id]`
P√°gina de reporte individual de sucursal.

**Funcionalidades:**
- M√©tricas espec√≠ficas de la sucursal
- Desempe√±o de profesionales
- Servicios m√°s solicitados
- Tendencias de la sucursal
- Utilizaci√≥n de recursos

## üìä M√©tricas Calculadas

### M√©tricas de Citas (AppointmentMetrics)
```typescript
{
  total: number,              // Total de citas
  pending: number,            // Citas pendientes
  confirmed: number,          // Citas confirmadas
  completed: number,          // Citas completadas
  cancelled: number,          // Citas canceladas
  noShow: number,            // No shows
  completionRate: number,    // Tasa de completado (%)
  cancellationRate: number,  // Tasa de cancelaci√≥n (%)
  noShowRate: number         // Tasa de no show (%)
}
```

### M√©tricas de Ingresos (RevenueMetrics)
```typescript
{
  totalRevenue: number,      // Ingresos totales
  averageRevenue: number,    // Ingreso promedio por cita
  projectedRevenue: number,  // Ingresos proyectados (incluye pendientes)
  revenueByStatus: {
    completed: number,       // Ingresos de citas completadas
    pending: number,         // Ingresos potenciales pendientes
    confirmed: number        // Ingresos potenciales confirmados
  }
}
```

### M√©tricas de Tiempo (TimeMetrics)
```typescript
{
  totalHours: number,                    // Total de horas trabajadas
  averageAppointmentDuration: number,    // Duraci√≥n promedio (minutos)
  utilizationRate: number,               // Tasa de utilizaci√≥n (%)
  peakHours: Array<{                     // Horas pico
    hour: number,
    count: number
  }>
}
```

### M√©tricas de Clientes (ClientMetrics)
```typescript
{
  totalClients: number,          // Total de clientes √∫nicos
  newClients: number,            // Clientes nuevos en el per√≠odo
  returningClients: number,      // Clientes recurrentes
  clientRetentionRate: number    // Tasa de retenci√≥n (%)
}
```

## üé® Visualizaciones

### Gr√°ficos Implementados

1. **Gr√°ficos de L√≠nea (LineChart)**
   - Tendencia de citas en el tiempo
   - Tendencia de ingresos en el tiempo
   - Evoluci√≥n de m√©tricas

2. **Gr√°ficos de Barras (BarChart)**
   - Top profesionales por ingresos
   - Top sucursales por ingresos
   - Servicios m√°s realizados
   - Horas pico de actividad

3. **Gr√°ficos de Pastel (PieChart)**
   - Distribuci√≥n de estados de citas
   - Proporci√≥n de tipos de clientes

4. **Tarjetas de M√©tricas**
   - Valores principales con iconos
   - Comparativas y porcentajes
   - Indicadores de tendencia

### Librer√≠a de Gr√°ficos
**Recharts** - Librer√≠a de gr√°ficos React responsiva y personalizable

**Caracter√≠sticas:**
- Totalmente responsiva
- Animaciones suaves
- Tooltips interactivos
- Leyendas configurables
- M√∫ltiples tipos de gr√°ficos
- Personalizaci√≥n de colores y estilos

## üîß Tipos TypeScript

### Archivo: `app/lib/types/reports.ts`

**Enums:**
- `ReportPeriod` - Per√≠odos de reporte
- `AppointmentStatus` - Estados de citas
- `ReportType` - Tipos de reporte

**Interfaces:**
- `DateRange` - Rango de fechas
- `ReportFilters` - Filtros de reporte
- `AppointmentMetrics` - M√©tricas de citas
- `RevenueMetrics` - M√©tricas de ingresos
- `TimeMetrics` - M√©tricas de tiempo
- `ClientMetrics` - M√©tricas de clientes
- `ProfessionalReport` - Reporte de profesional
- `BranchReport` - Reporte de sucursal
- `OverviewReport` - Reporte general
- `ComparisonReport` - Reporte comparativo
- `ReportResponse<T>` - Respuesta API gen√©rica
- `ReportError` - Error de reporte

## üìÅ Estructura de Archivos

```
app/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reports.ts                    # Tipos TypeScript (350+ l√≠neas)
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ reportManager.ts              # Servicio de reportes (800+ l√≠neas)
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ reports/
‚îÇ       ‚îú‚îÄ‚îÄ professional/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ route.ts              # API profesional
‚îÇ       ‚îú‚îÄ‚îÄ branch/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ route.ts              # API sucursal
‚îÇ       ‚îú‚îÄ‚îÄ overview/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ route.ts                  # API overview
‚îÇ       ‚îî‚îÄ‚îÄ comparison/
‚îÇ           ‚îî‚îÄ‚îÄ route.ts                  # API comparaci√≥n
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ReportDashboard.tsx               # Dashboard general (400+ l√≠neas)
‚îÇ   ‚îú‚îÄ‚îÄ ProfessionalReportView.tsx        # Vista profesional (450+ l√≠neas)
‚îÇ   ‚îî‚îÄ‚îÄ BranchReportView.tsx              # Vista sucursal (450+ l√≠neas)
‚îî‚îÄ‚îÄ dashboard/
    ‚îî‚îÄ‚îÄ reports/
        ‚îú‚îÄ‚îÄ page.tsx                      # P√°gina principal
        ‚îú‚îÄ‚îÄ professional/
        ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
        ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx              # P√°gina profesional
        ‚îî‚îÄ‚îÄ branch/
            ‚îî‚îÄ‚îÄ [id]/
                ‚îî‚îÄ‚îÄ page.tsx              # P√°gina sucursal
```

## üöÄ Casos de Uso

### Caso 1: An√°lisis de Desempe√±o Individual
**Escenario**: Gerente quiere evaluar el desempe√±o de un profesional

**Flujo:**
1. Navegar a `/dashboard/reports/professional/[id]`
2. Seleccionar per√≠odo (ej: √∫ltimo mes)
3. Visualizar m√©tricas clave
4. Analizar tendencias de citas e ingresos
5. Revisar desempe√±o por sucursal
6. Identificar servicios m√°s realizados

**M√©tricas Clave:**
- Tasa de completado de citas
- Ingresos generados
- Clientes atendidos
- Horas trabajadas
- Servicios m√°s populares

### Caso 2: Evaluaci√≥n de Sucursal
**Escenario**: Due√±o quiere analizar el rendimiento de una sucursal

**Flujo:**
1. Navegar a `/dashboard/reports/branch/[id]`
2. Seleccionar per√≠odo (ej: √∫ltimo trimestre)
3. Revisar m√©tricas generales
4. Comparar desempe√±o de profesionales
5. Analizar servicios m√°s solicitados
6. Evaluar utilizaci√≥n de recursos

**M√©tricas Clave:**
- Ingresos totales de la sucursal
- N√∫mero de clientes atendidos
- Tasa de utilizaci√≥n
- Desempe√±o de profesionales
- Servicios m√°s rentables

### Caso 3: Vista General del Negocio
**Escenario**: Administrador necesita vista consolidada

**Flujo:**
1. Navegar a `/dashboard/reports`
2. Seleccionar per√≠odo (ej: √∫ltimo a√±o)
3. Visualizar m√©tricas consolidadas
4. Revisar top performers
5. Analizar tendencias generales
6. Identificar oportunidades de mejora

**M√©tricas Clave:**
- Ingresos totales del negocio
- Crecimiento de clientes
- Top profesionales y sucursales
- Servicios m√°s rentables
- Tendencias de crecimiento

### Caso 4: Comparaci√≥n de Desempe√±o
**Escenario**: Comparar m√∫ltiples profesionales o sucursales

**Flujo:**
1. Usar endpoint `/api/reports/comparison`
2. Especificar tipo (professional o branch)
3. Proporcionar IDs a comparar
4. Seleccionar per√≠odo
5. Analizar m√©tricas lado a lado
6. Identificar mejores pr√°cticas

**M√©tricas Comparadas:**
- Citas completadas
- Ingresos generados
- Tasa de retenci√≥n de clientes
- Eficiencia operativa

## üìà Estad√≠sticas del Desarrollo

- **Archivos nuevos**: 14
- **L√≠neas de c√≥digo**: ~3,500
- **Componentes React**: 3
- **Endpoints API**: 4
- **Tipos TypeScript**: 20+
- **M√©todos de servicio**: 12+
- **Gr√°ficos implementados**: 6 tipos

## üîÑ Integraci√≥n con Sistema Existente

### Con Fase 1 (Horarios)
```typescript
// Calcular horas trabajadas considerando horarios
const scheduleConfig = professional.scheduleConfig;
const workingHours = calculateWorkingHours(scheduleConfig, dateRange);
```

### Con Fase 2 (Asignaciones)
```typescript
// Reportes por sucursal considerando asignaciones
const assignments = await prisma.branchAssignment.findMany({
  where: { professionalId, isActive: true }
});
```

### Con Sistema de Citas
```typescript
// M√©tricas basadas en citas reales
const appointments = await prisma.appointment.findMany({
  where: {
    professionalId,
    startTime: { gte: startDate, lte: endDate }
  }
});
```

## üéØ Pr√≥ximos Pasos (Futuras Mejoras)

### Fase 4: Exportaci√≥n y Compartir
1. **Exportaci√≥n a PDF**
   - Generar reportes en PDF
   - Incluir gr√°ficos y tablas
   - Personalizaci√≥n de formato

2. **Exportaci√≥n a Excel**
   - Datos tabulares
   - M√∫ltiples hojas
   - F√≥rmulas y gr√°ficos

3. **Compartir Reportes**
   - Enlaces compartibles
   - Permisos de acceso
   - Reportes programados

### Fase 5: An√°lisis Avanzado
1. **Predicciones**
   - Machine learning para proyecciones
   - An√°lisis de tendencias
   - Recomendaciones autom√°ticas

2. **Alertas Inteligentes**
   - Notificaciones de anomal√≠as
   - Alertas de bajo desempe√±o
   - Oportunidades de mejora

3. **Benchmarking**
   - Comparaci√≥n con industria
   - Mejores pr√°cticas
   - Objetivos y metas

## ‚úÖ Checklist de Implementaci√≥n

- [x] Tipos TypeScript definidos
- [x] Servicio ReportManager completo
- [x] Endpoints API implementados
- [x] Componentes UI desarrollados
- [x] P√°ginas de dashboard creadas
- [x] Gr√°ficos y visualizaciones
- [x] Filtros de fecha funcionales
- [x] M√©tricas calculadas correctamente
- [x] Integraci√≥n con sistema existente
- [x] Documentaci√≥n completa
- [x] Sin breaking changes
- [ ] Tests unitarios (Pendiente)
- [ ] Tests de integraci√≥n (Pendiente)
- [ ] Exportaci√≥n a PDF (Futuro)
- [ ] Reportes programados (Futuro)

## üéâ Impacto

Esta implementaci√≥n permite:

1. ‚úÖ **Toma de Decisiones Informada**
   - Datos en tiempo real
   - M√©tricas clave visualizadas
   - Tendencias identificadas

2. ‚úÖ **Evaluaci√≥n de Desempe√±o**
   - Profesionales individuales
   - Sucursales espec√≠ficas
   - Comparativas objetivas

3. ‚úÖ **Optimizaci√≥n de Recursos**
   - Identificar horas pico
   - Asignar personal eficientemente
   - Maximizar utilizaci√≥n

4. ‚úÖ **Crecimiento del Negocio**
   - Identificar servicios rentables
   - Retener clientes valiosos
   - Expandir estrat√©gicamente

5. ‚úÖ **Transparencia Operativa**
   - Visibilidad completa
   - M√©tricas objetivas
   - Reportes profesionales

---

**Versi√≥n**: 1.6.0 ‚Üí 1.7.0  
**Tipo**: Feature  
**Breaking Changes**: No  
**Requiere Migraci√≥n**: No  
**Estado**: ‚úÖ Listo para Review y Merge

**Relacionado con**: Fase 1 (Horarios), Fase 2 (Asignaciones), Sistema de Citas
